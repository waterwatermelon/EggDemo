"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const cluster_1 = tslib_1.__importDefault(require("cluster"));
const debug_1 = tslib_1.__importDefault(require("debug"));
const _1 = require("./");
const util = tslib_1.__importStar(require("./utils"));
const debug = debug_1.default('egg-ts-helper#register');
const shouldWatch = util.convertString(process.env.ETS_WATCH, process.env.NODE_ENV !== 'test');
/* istanbul ignore else */
if (cluster_1.default.isMaster) {
    // make sure ets only run once
    const pid = process.env.ETS_REGISTER_PID;
    if (pid && shouldWatch) {
        debug('egg-ts-helper watcher has ran in %s', pid);
    }
    else {
        register(shouldWatch);
    }
}
// start to register
function register(watch) {
    const cwd = process.cwd();
    if (util.checkMaybeIsJsProj(cwd)) {
        // write jsconfig if the project is wrote by js
        util.writeJsConfig(cwd);
    }
    else {
        // no need to clean in js project
        // clean local js file at first.
        // because egg-loader cannot load the same property name to egg.
        util.cleanJs(cwd);
    }
    if (watch) {
        // cache pid to env, prevent child process executing ets again
        process.env.ETS_REGISTER_PID = `${process.pid}`;
    }
    // exec building
    _1.createTsHelperInstance({ watch }).build();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcmVnaXN0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsOERBQThCO0FBQzlCLDBEQUFzQjtBQUN0Qix5QkFBNEM7QUFDNUMsc0RBQWdDO0FBQ2hDLE1BQU0sS0FBSyxHQUFHLGVBQUMsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO0FBQzFDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEtBQUssTUFBTSxDQUFDLENBQUM7QUFFL0YsMEJBQTBCO0FBQzFCLElBQUksaUJBQU8sQ0FBQyxRQUFRLEVBQUU7SUFDcEIsOEJBQThCO0lBQzlCLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLENBQUM7SUFDekMsSUFBSSxHQUFHLElBQUksV0FBVyxFQUFFO1FBQ3RCLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLENBQUMsQ0FBQztLQUNuRDtTQUFNO1FBQ0wsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ3ZCO0NBQ0Y7QUFFRCxvQkFBb0I7QUFDcEIsU0FBUyxRQUFRLENBQUMsS0FBYztJQUM5QixNQUFNLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDMUIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEVBQUU7UUFDaEMsK0NBQStDO1FBQy9DLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDekI7U0FBTTtRQUNMLGlDQUFpQztRQUNqQyxnQ0FBZ0M7UUFDaEMsZ0VBQWdFO1FBQ2hFLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7S0FDbkI7SUFFRCxJQUFJLEtBQUssRUFBRTtRQUNULDhEQUE4RDtRQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixHQUFHLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDO0tBQ2pEO0lBRUQsZ0JBQWdCO0lBQ2hCLHlCQUFzQixDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUM1QyxDQUFDIn0=